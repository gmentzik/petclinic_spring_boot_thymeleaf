<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0" />
  <title>BezKoder - Spring Boot Thymeleaf example</title>

  <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" />
  <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <script type="text/javascript" th:src="@{/webjars/jquery/jquery.min.js}"></script>
  <script type="text/javascript" th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
</head>

<body>
  <div th:replace="fragments/header :: header"></div>

  <div class="container-fluid">
    <h2 class="text-center">[[${pageTitle}]]</h2>
    </br>
    <h4 th:text="'Pet: ' + ${pet.name} + ' (' + ${pet.id} + ')'"></h4>
    <h4 th:text="'Customer: ' + ${customer.firstName} + ' ' + ${customer.surName} + ' (' + ${customer.id} + ')'"></h4>

    <div class="my-3">
      <form id="medicalHistoryForm" th:action="@{'/customers/' + ${customer.id} + '/pets/' + ${pet.id} + '/medicalhistoryrecord/save'}" method="post" enctype="multipart/form-data" th:object="${medicalhistory}"
        style="max-width: 900px; margin: 0 auto">
        <input type="hidden" th:field="*{id}" />

        <div class="p-3">
          <!-- Created/Updated info (only for existing records) -->
          <div class="form-group row" th:if="*{id} != null">
            <label class="col-sm-3 col-form-label">Created</label>
            <div class="col-sm-9">
              <input type="text" class="form-control" th:value="*{created}" readonly />
            </div>
          </div>
          <div class="form-group row" th:if="*{id} != null">
            <label class="col-sm-3 col-form-label">Last Updated</label>
            <div class="col-sm-9">
              <input type="text" class="form-control" th:value="*{updated}" readonly />
            </div>
          </div>

          <div class="form-group row">
            <label class="col-sm-3 col-form-label" for="report">Report</label>
            <div class="col-sm-9">
              <textarea class="form-control" th:field="*{report}" required minlength="2" maxlength="4096" id="report" rows="10"></textarea>
            </div>
          </div>

          <!-- Images Section -->
          <div class="form-group row">
            <label class="col-sm-3 col-form-label">Medical Images</label>
            <div class="col-sm-9">
              <!-- Single Image Upload Form -->
              <div class="border p-3 rounded mb-3">
                <div class="input-group">
                  <div class="custom-file">
                    <input type="file" id="imageInput" class="custom-file-input" accept="image/*">
                    <label class="custom-file-label" for="imageInput">Choose image</label>
                  </div>
                  <div class="input-group-append">
                    <button type="button" id="addImageBtn" class="btn btn-outline-primary">
                      <i class="fas fa-plus mr-1"></i> Add Image
                    </button>
                  </div>
                </div>
                <div class="input-group mt-2">
                  <input type="text" id="imageDescription" class="form-control" placeholder="Image description (optional)" maxlength="255">
                </div>
              </div>
              
              <!-- Table for Added Images -->
              <div id="imageTableContainer" class="mt-3" style="display: none;">
                <h6>Added Images</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-hover">
                    <thead class="thead-light">
                      <tr>
                        <th>Preview</th>
                        <th>Description</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="imageTableBody">
                      <!-- Rows will be added here dynamically -->
                    </tbody>
                  </table>
                </div>
              </div>
              <small class="form-text text-muted">You can upload multiple images. Each can have an optional description.</small>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center">
            <div>
              <!-- Show only when editing an existing medical history record -->
              <a th:if="*{id} != null"
                 id="btnDelete"
                 class="btn btn-danger btn-sm"
                 th:attr="data-history-id=*{id}">
                 <i class="fa fa-trash-alt mr-1"></i> Delete
              </a>
              <noscript>
                <div class="text-muted small mt-1">Deleting requires JavaScript. Please enable JavaScript to delete this record.</div>
              </noscript>
            </div>
            <div>
              <button type="button" id="btnSave" class="btn btn-primary btn-sm mr-2">
                <i class="fa fa-save mr-1"></i> Save
              </button>
              <button type="button" id="btnCancel" class="btn btn-secondary btn-sm">
                <i class="fa fa-times mr-1"></i> Cancel
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Save confirmation modal -->
  <div class="modal fade text-center" id="saveConfirmModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Save Confirmation</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <span>Do you want to save the changes?</span>
        </div>
        <div class="modal-footer">
          <button type="button" id="yesSaveBtn" class="btn btn-primary">Yes</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete confirmation modal -->
  <div class="modal fade text-center" id="confirmModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete Confirmation</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <span id="confirmText"></span>
        </div>
        <div class="modal-footer">
          <a type="button" id="yesBtn" class="btn btn-danger">Yes</a>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
        </div>
      </div>
    </div>
  </div>

  <div th:replace="fragments/footer :: footer"></div>

  <script type="text/javascript">
      $(document).ready(function () {
        // Initialize tooltips
        $('[data-toggle="tooltip"]').tooltip();
        
        // Handle image preview and table row creation
        function addImageToTable(file, description = '') {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const rowId = 'img-' + Date.now();
            const previewUrl = e.target.result;
            
            // Create a new row in the table
            const newRow = `
              <tr id="${rowId}">
                <td class="align-middle">
                  <img src="${previewUrl}" alt="Preview" style="max-width: 100px; max-height: 60px;" class="img-thumbnail">
                </td>
                <td class="align-middle">
                  ${description || '<span class="text-muted">No description</span>'}
                </td>
                <td class="align-middle">
                  <button type="button" class="btn btn-outline-danger btn-sm btn-remove-row">
                    <i class="fas fa-minus"></i>
                  </button>
                </td>
              </tr>`;
            
            // Create a container for the form inputs (hidden from view)
            const formInputs = `
              <div class="d-none">
                <input type="file" name="images" class="d-none" data-row-id="${rowId}">
                <input type="text" name="imageDescriptions" value="${description}" data-row-id="${rowId}">
              </div>
            `;
            
            // Add the row to the table
            $('#imageTableBody').prepend(newRow);
            
            // Add the form inputs to the form
            $('#medicalHistoryForm').append(formInputs);
            
            // Set the file data to the hidden input using DataTransfer
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            $(`input[name="images"][data-row-id="${rowId}"]`)[0].files = dataTransfer.files;
            
            // Show the table if it was hidden
            if ($('#imageTableContainer').is(':hidden')) {
              $('#imageTableContainer').fadeIn();
            }
            
            // Clear the form
            $('#imageInput').val('');
            $('.custom-file-label').text('Choose image');
            $('#imageDescription').val('');
          };
          
          reader.readAsDataURL(file);
        }
        
        // Handle Add Image button click
        $('#addImageBtn').on('click', function() {
          const fileInput = document.getElementById('imageInput');
          const description = $('#imageDescription').val().trim();
          
          if (fileInput.files.length === 0) {
            alert('Please select an image file');
            return;
          }
          
          addImageToTable(fileInput.files[0], description);
        });
        
        // Handle file input change to update the label
        $('#imageInput').on('change', function() {
          const fileName = $(this).val().split('\\').pop();
          $(this).next('.custom-file-label').addClass('selected').html(fileName || 'Choose image');
        });
        
        // Handle remove row button
        $(document).on('click', '.btn-remove-row', function() {
            const row = $(this).closest('tr');
            const rowId = row.attr('id');
            
            // Remove the corresponding form inputs
            $(`[data-row-id="${rowId}"]`).closest('div').remove();
            
            // Remove the row with animation
            row.fadeOut(300, function() {
                row.remove();
                // Hide the table if no images left
                if ($('#imageTableBody tr').length === 0) {
                    $('#imageTableContainer').fadeOut();
                }
            });
        });
        
        // Cancel -> back to medical history list
        $("#btnCancel").on("click", function () {
          window.location = "[[@{'/customers/' + ${customer.id} + '/pets/' + ${pet.id} + '/medicalhistory'}]]";
        });

        // Save confirmation
        $("#btnSave").on("click", function (e) {
          e.preventDefault();
          $("#saveConfirmModal").modal();
        });

        $("#yesSaveBtn").on("click", function () {
          $("#saveConfirmModal").modal('hide');
          
          // Submit the form programmatically to ensure all files are included
          const form = document.getElementById('medicalHistoryForm');
          const formData = new FormData(form);
          
          // Add any additional data if needed
          formData.append('petId', '${pet.id}');
          formData.append('customerId', '${customer.id}');
          
          // Submit the form with the FormData
          fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'  // For CSRF protection
            }
          })
          .then(response => {
            if (response.redirected) {
              window.location.href = response.url;
            } else {
              return response.text().then(text => {
                // Handle non-redirect responses if needed
                console.log('Form submission response:', text);
              });
            }
          })
          .catch(error => {
            console.error('Error submitting form:', error);
            alert('An error occurred while saving. Please try again.');
          });
        });

        // Delete confirmation
        $("#btnDelete").on("click", function (e) {
          e.preventDefault();
          var historyId = $(this).data("historyId");
          var deleteUrl = "[[@{/medicalhistory/delete/}]]" + historyId;
          $("#yesBtn").attr("href", deleteUrl);
          $("#confirmText").html("Do you want to delete this medical history record (ID: <strong>" + historyId + "</strong>)?");
          $("#confirmModal").modal();
        });
      });
  </script>

</html>